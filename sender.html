<!DOCTYPE html>
<html>
<head>
  <title>Sender</title>
</head>
<body>
  <h2>Sender</h2>
  <button id="startBtn" onclick="start()">Start Sharing</button>
  <button id="stopBtn" onclick="stop()" disabled>Stop Sharing</button>

  <script>
    let peer = null;
    let stream = null;
    let socket = null;

    // Disable start button until socket is ready
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    startBtn.disabled = true;

    function setupSocket() {
      return new Promise((resolve, reject) => {
        socket = new WebSocket(`wss://${location.host}`);

        socket.onopen = () => {
          console.log("WebSocket connected");
          socket.send(JSON.stringify({ type: "register", role: "sender" }));
          startBtn.disabled = false;  // Enable start button now
          resolve();
        };

        socket.onerror = (err) => {
          console.error("WebSocket error:", err);
          reject(err);
        };

        socket.onmessage = async (event) => {
          const data = JSON.parse(event.data);
          if (!peer) return;

          if (data.type === 'answer') {
            await peer.setRemoteDescription(data.answer);
          } else if (data.type === 'candidate') {
            try {
              await peer.addIceCandidate(new RTCIceCandidate(data.candidate));
            } catch (e) {
              console.warn("Error adding ICE candidate:", e);
            }
          }
        };

        socket.onclose = () => {
          console.log("WebSocket closed");
          stop();
        };
      });
    }

    async function start() {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        alert("WebSocket not connected yet, please wait and try again.");
        return;
      }

      if (peer) {
        console.log("Already sharing");
        return;
      }

      peer = new RTCPeerConnection();

      peer.onicecandidate = (event) => {
        if (event.candidate) {
          socket.send(JSON.stringify({ type: "candidate", candidate: event.candidate }));
        }
      };

      try {
        stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        stream.getTracks().forEach(track => {
          peer.addTrack(track, stream);
          track.onended = () => {
            console.log("Track ended");
            stop();
          };
        });

        const offer = await peer.createOffer();
        await peer.setLocalDescription(offer);
        socket.send(JSON.stringify({ type: 'offer', offer }));

        // Update UI
        startBtn.disabled = true;
        stopBtn.disabled = false;

      } catch (err) {
        console.error("Error starting screen share:", err);
        stop();
      }
    }

    function stop() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }

      if (peer) {
        peer.close();
        peer = null;
      }

      startBtn.disabled = false;
      stopBtn.disabled = true;

      console.log("Stopped sharing");
    }

    // Initialize socket connection on page load
    setupSocket().catch(e => {
      alert("Failed to connect signaling server.");
    });
  </script>
</body>
</html>
